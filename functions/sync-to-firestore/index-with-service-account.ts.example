/**
 * 使用 Service Account 的版本（範例）
 * 
 * 注意：這個版本需要額外的依賴和配置
 * 推薦使用 Web API Key（更簡單）
 */

import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
import { create } from 'https://deno.land/x/djwt@v2.8/mod.ts'

// Service Account 配置
const FIREBASE_PROJECT_ID = Deno.env.get('FIREBASE_PROJECT_ID')!
const FIREBASE_SERVICE_ACCOUNT = JSON.parse(Deno.env.get('FIREBASE_SERVICE_ACCOUNT')!)

// Supabase 配置
const SUPABASE_URL = Deno.env.get('SUPABASE_URL')!
const SUPABASE_SERVICE_ROLE_KEY = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!

/**
 * 使用 Service Account 生成 Access Token
 */
async function getAccessToken(): Promise<string> {
  const now = Math.floor(Date.now() / 1000)
  
  // 創建 JWT
  const jwt = await create(
    { alg: 'RS256', typ: 'JWT' },
    {
      iss: FIREBASE_SERVICE_ACCOUNT.client_email,
      sub: FIREBASE_SERVICE_ACCOUNT.client_email,
      aud: 'https://oauth2.googleapis.com/token',
      iat: now,
      exp: now + 3600,
      scope: 'https://www.googleapis.com/auth/datastore',
    },
    FIREBASE_SERVICE_ACCOUNT.private_key
  )

  // 交換 Access Token
  const response = await fetch('https://oauth2.googleapis.com/token', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: new URLSearchParams({
      grant_type: 'urn:ietf:params:oauth:grant-type:jwt-bearer',
      assertion: jwt,
    }),
  })

  const data = await response.json()
  return data.access_token
}

/**
 * 創建或更新 Firestore 文檔（使用 Service Account）
 */
async function upsertFirestoreDocument(orderId: string, data: any): Promise<void> {
  // 獲取 Access Token
  const accessToken = await getAccessToken()
  
  const url = `https://firestore.googleapis.com/v1/projects/${FIREBASE_PROJECT_ID}/databases/(default)/documents/orders_rt/${orderId}`
  
  const firestoreFields = convertToFirestoreFields(data)

  const response = await fetch(url, {
    method: 'PATCH',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${accessToken}`,  // 使用生成的 Access Token
    },
    body: JSON.stringify({
      fields: firestoreFields,
    }),
  })

  if (!response.ok) {
    const error = await response.text()
    throw new Error(`Firestore 更新失敗: ${error}`)
  }

  console.log(`Firestore 文檔已更新: orders_rt/${orderId}`)
}

// ... 其他代碼保持不變

